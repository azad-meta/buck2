"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2988],{45787:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>u,frontMatter:()=>c,metadata:()=>l,toc:()=>s});var i=r(74848),t=r(15680);const c={},a="Buck support to implement configured_alias",l={id:"rfcs/configured-alias",title:"Buck support to implement configured_alias",description:"Intro",source:"@site/../docs/rfcs/configured-alias.md",sourceDirName:"rfcs",slug:"/rfcs/configured-alias",permalink:"/docs/rfcs/configured-alias",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{}},o={},s=[{value:"Intro",id:"intro",level:2},{value:"What is <code>configured_alias</code>?",id:"what-is-configured_alias",level:2},{value:"How to implement it in buck v2?",id:"how-to-implement-it-in-buck-v2",level:2},{value:"New rule attribute type: <code>configured_dep</code>",id:"new-rule-attribute-type-configured_dep",level:3},{value:"<code>configured_alias_impl</code> user defined rule",id:"configured_alias_impl-user-defined-rule",level:3},{value:"Finally, <code>configured_alias</code> macro",id:"finally-configured_alias-macro",level:3},{value:"Alternatives",id:"alternatives",level:2},{value:"No <code>configured_alias</code>",id:"no-configured_alias",level:3},{value:"Use <code>@configuration</code> syntax from another RFC.",id:"use-configuration-syntax-from-another-rfc",level:3},{value:"Accept <code>configured_target_label</code> in <code>dep</code> attribute",id:"accept-configured_target_label-in-dep-attribute",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.useMDXComponents)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsxs)(n.h1,{id:"buck-support-to-implement-configured_alias",children:["Buck support to implement ",(0,i.jsx)(n.code,{children:"configured_alias"})]})}),"\n",(0,i.jsx)(n.h2,{id:"intro",children:"Intro"}),"\n",(0,i.jsxs)(n.p,{children:["Currently, Buck 2 lacks ",(0,i.jsx)(n.code,{children:"configured_alias"})," rule support."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"configured_alias"})," is a builtin rule in Buck v1, and it cannot be currently\nimplemented as user defined rule in Buck v2."]}),"\n",(0,i.jsxs)(n.p,{children:["This RFC proposes Buck core support for ",(0,i.jsx)(n.code,{children:"configured_alias"}),"."]}),"\n",(0,i.jsxs)(n.h2,{id:"what-is-configured_alias",children:["What is ",(0,i.jsx)(n.code,{children:"configured_alias"}),"?"]}),"\n",(0,i.jsx)(n.p,{children:"Syntax is this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'configured_alias(\n    name = "foo-but-linux-release",\n    actual = ":foo",\n    platform = "config//platforms:linux-release",\n)\n'})}),"\n",(0,i.jsx)(n.p,{children:'When this rule is built, it ignores "current" target configuration, and builds\nthe "actual" target with the configuration specified as "platform" argument.'}),"\n",(0,i.jsx)(n.h2,{id:"how-to-implement-it-in-buck-v2",children:"How to implement it in buck v2?"}),"\n",(0,i.jsxs)(n.h3,{id:"new-rule-attribute-type-configured_dep",children:["New rule attribute type: ",(0,i.jsx)(n.code,{children:"configured_dep"})]}),"\n",(0,i.jsx)(n.p,{children:"Currently, we have several dependency attributes:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"attrs.dep"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"attrs.exec_dep"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"attrs.transition_dep"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"attrs.split_transition_dep"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This RFC proposes adding another attribute:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"attrs.configured_dep"})}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"configured_dep"})," is an attribute which accepts a pair of strings: target and\nconfiguration. During analysis, configured attr deps are resolved to providers\nresolved using given configuration."]}),"\n",(0,i.jsxs)(n.h3,{id:"configured_alias_impl-user-defined-rule",children:[(0,i.jsx)(n.code,{children:"configured_alias_impl"})," user defined rule"]}),"\n",(0,i.jsx)(n.p,{children:"The rule implementation is trivial:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'\ndef _configured_alias_impl(ctx):\n    return ctx.attrs.actual.providers\n\nconfigured_alias_impl = rule(\n    impl = _configured_alias_impl,\n    attrs = {\n        "actual": attrs.configured_dep(),\n    }\n)\n'})}),"\n",(0,i.jsxs)(n.h3,{id:"finally-configured_alias-macro",children:["Finally, ",(0,i.jsx)(n.code,{children:"configured_alias"})," macro"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"def configured_alias(name, actual, platform):\n    configured_alias_impl(name, actual = (actual, platform))\n"})}),"\n",(0,i.jsx)(n.h2,{id:"alternatives",children:"Alternatives"}),"\n",(0,i.jsxs)(n.h3,{id:"no-configured_alias",children:["No ",(0,i.jsx)(n.code,{children:"configured_alias"})]}),"\n",(0,i.jsxs)(n.p,{children:["Each specific case where ",(0,i.jsx)(n.code,{children:"configured_alias"})," is used, it can be done with\ndefining custom transition, and using custom transition rule."]}),"\n",(0,i.jsxs)(n.p,{children:["But having ",(0,i.jsx)(n.code,{children:"configured_alias"})," is a convenient stopgap to unblock people."]}),"\n",(0,i.jsxs)(n.h3,{id:"use-configuration-syntax-from-another-rfc",children:["Use ",(0,i.jsx)(n.code,{children:"@configuration"})," syntax from ",(0,i.jsx)(n.a,{href:"https://www.internalfb.com/diff/D35136639",children:"another RFC"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Instead of passing ",(0,i.jsx)(n.code,{children:"confiured_target_label(x, y)"})," pass ",(0,i.jsx)(n.code,{children:'x + "@" + y'}),"."]}),"\n",(0,i.jsxs)(n.h3,{id:"accept-configured_target_label-in-dep-attribute",children:["Accept ",(0,i.jsx)(n.code,{children:"configured_target_label"})," in ",(0,i.jsx)(n.code,{children:"dep"})," attribute"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"dep"})," attribute could support all of:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"regular target label as string"}),"\n",(0,i.jsxs)(n.li,{children:["configured target label (as either ",(0,i.jsx)(n.code,{children:"configured_target_label"})," or ",(0,i.jsx)(n.code,{children:"x@y"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"I don't know practical applications for this magic, and unless there are uses\nfor it, better keep API simple and explicit."})]})}function u(e={}){const{wrapper:n}={...(0,t.useMDXComponents)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},15680:(e,n,r)=>{r.r(n),r.d(n,{MDXContext:()=>s,MDXProvider:()=>p,mdx:()=>m,useMDXComponents:()=>u,withMDXComponents:()=>d});var i=r(96540);function t(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function c(){return c=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var r=arguments[n];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e},c.apply(this,arguments)}function a(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,i)}return r}function l(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?a(Object(r),!0).forEach((function(n){t(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function o(e,n){if(null==e)return{};var r,i,t=function(e,n){if(null==e)return{};var r,i,t={},c=Object.keys(e);for(i=0;i<c.length;i++)r=c[i],n.indexOf(r)>=0||(t[r]=e[r]);return t}(e,n);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(i=0;i<c.length;i++)r=c[i],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(t[r]=e[r])}return t}var s=i.createContext({}),d=function(e){return function(n){var r=u(n.components);return i.createElement(e,c({},n,{components:r}))}},u=function(e){var n=i.useContext(s),r=n;return e&&(r="function"==typeof e?e(n):l(l({},n),e)),r},p=function(e){var n=u(e.components);return i.createElement(s.Provider,{value:n},e.children)},f="mdxType",h={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},g=i.forwardRef((function(e,n){var r=e.components,t=e.mdxType,c=e.originalType,a=e.parentName,s=o(e,["components","mdxType","originalType","parentName"]),d=u(r),p=t,f=d["".concat(a,".").concat(p)]||d[p]||h[p]||c;return r?i.createElement(f,l(l({ref:n},s),{},{components:r})):i.createElement(f,l({ref:n},s))}));function m(e,n){var r=arguments,t=n&&n.mdxType;if("string"==typeof e||t){var c=r.length,a=new Array(c);a[0]=g;var l={};for(var o in n)hasOwnProperty.call(n,o)&&(l[o]=n[o]);l.originalType=e,l[f]="string"==typeof e?e:t,a[1]=l;for(var s=2;s<c;s++)a[s]=r[s];return i.createElement.apply(null,a)}return i.createElement.apply(null,r)}g.displayName="MDXCreateElement"}}]);