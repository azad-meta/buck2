"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[8319],{23091:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>a,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>d});var r=i(74848),l=i(15680);const c={id:"package_files",title:"PACKAGE Files"},a=void 0,s={id:"rule_authors/package_files",title:"PACKAGE Files",description:"PACKAGE files are per-directory configuration files which are accessible from",source:"@site/../docs/rule_authors/package.md",sourceDirName:"rule_authors",slug:"/rule_authors/package_files",permalink:"/docs/rule_authors/package_files",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{id:"package_files",title:"PACKAGE Files"},sidebar:"main",previous:{title:"Local Resources For Tests Execution",permalink:"/docs/rule_authors/local_resources"},next:{title:"Dep Files",permalink:"/docs/rule_authors/dep_files"}},t={},d=[{value:"APIs",id:"apis",level:2},{value:"<code>PACKAGE</code> APIs",id:"package-apis",level:3},{value:"<code>write_package_value</code>",id:"write_package_value",level:4},{value:"<code>read_parent_package_value</code>",id:"read_parent_package_value",level:4},{value:"<code>package</code>",id:"package",level:4},{value:"<code>read_config</code>",id:"read_config",level:4},{value:"<code>BUCK</code>-specific API",id:"buck-specific-api",level:3},{value:"<code>read_package_value</code>",id:"read_package_value",level:4}];function o(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",p:"p",pre:"pre",...(0,l.useMDXComponents)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"PACKAGE"})," files are per-directory configuration files which are accessible from\nStarlark rules/macros. It supports things like per-directory properties, reading\nparent ",(0,r.jsx)(n.code,{children:"PACKAGE"})," values (",(0,r.jsx)(n.code,{children:"read_parent_package_value()"}),"), writing ",(0,r.jsx)(n.code,{children:"PACKAGE"}),"\nvalues (",(0,r.jsx)(n.code,{children:"write_package_value()"}),"), loading helper ",(0,r.jsx)(n.code,{children:"bzl"})," files, and you can also\ninspect ",(0,r.jsx)(n.code,{children:"PACKAGE"})," values via ",(0,r.jsx)(n.code,{children:"buck2 audit package-values"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["Before evaluating ",(0,r.jsx)(n.code,{children:"BUCK"})," file, buck2 will evaluate all ",(0,r.jsx)(n.code,{children:"PACKAGE"})," files in the\nsame directory and all parent directories. Absent ",(0,r.jsx)(n.code,{children:"PACKAGE"})," files are treated as\nempty files."]}),"\n",(0,r.jsxs)(n.p,{children:["All relevant ",(0,r.jsx)(n.code,{children:"PACKAGE"})," files are executed sequentially from the root directory\nto the current directory (but unrelated ",(0,r.jsx)(n.code,{children:"PACKAGE"})," files can be executed in\nparallel). Evaluating ",(0,r.jsx)(n.code,{children:"PACKAGE"})," files sequentially provides additional\nguarantees, for example, attempt to override a property (unless explicitly\nrequested) should fail with Starlark call stack."]}),"\n",(0,r.jsxs)(n.p,{children:["Each ",(0,r.jsx)(n.code,{children:"PACKAGE"})," file is evaluated at most once (like ",(0,r.jsx)(n.code,{children:"bzl"})," files)."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"PACKAGE"})," files may load arbitrary ",(0,r.jsx)(n.code,{children:"bzl"})," files. ",(0,r.jsx)(n.code,{children:"BUCK"}),"-specific functions called\nin ",(0,r.jsx)(n.code,{children:"bzl"})," files (like rule functions) are available, but calling functions from\n",(0,r.jsx)(n.code,{children:"PACKAGE"})," files is an error. This way, ",(0,r.jsx)(n.code,{children:"bzl"})," files are evaluated only once\nregardless of whether they are loaded from ",(0,r.jsx)(n.code,{children:"PACKAGE"})," or ",(0,r.jsx)(n.code,{children:"BUCK"})," file."]}),"\n",(0,r.jsx)(n.h2,{id:"apis",children:"APIs"}),"\n",(0,r.jsxs)(n.h3,{id:"package-apis",children:[(0,r.jsx)(n.code,{children:"PACKAGE"})," APIs"]}),"\n",(0,r.jsx)(n.h4,{id:"write_package_value",children:(0,r.jsx)(n.a,{href:"../../api/build#write_package_value",children:(0,r.jsx)(n.code,{children:"write_package_value"})})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'def write_package_value(\n    name: str,\n    value: "",\n    overwrite: bool = False,\n): ...\n'})}),"\n",(0,r.jsxs)(n.p,{children:["This global API is only available in ",(0,r.jsx)(n.code,{children:"PACKAGE"})," files, or ",(0,r.jsx)(n.code,{children:"bzl"})," files included in\n",(0,r.jsx)(n.code,{children:"PACKAGE"})," files."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"name"})," is a string which must contain exactly one dot symbol (just to enforce\ncode style)."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"value"})," is an arbitrary Starlark value, for example, an integer, a list of\ninteger, a struct or a function. The value must be serializable into JSON."]}),"\n",(0,r.jsxs)(n.p,{children:["When ",(0,r.jsx)(n.code,{children:"overwrite"})," is ",(0,r.jsx)(n.code,{children:"False"})," (default), attempt to overwrite per-",(0,r.jsx)(n.code,{children:"PACKAGE"})," value\ndefined in parent ",(0,r.jsx)(n.code,{children:"PACKAGE"})," file will fail."]}),"\n",(0,r.jsxs)(n.p,{children:["Written values are frozen when ",(0,r.jsx)(n.code,{children:"PACKAGE"})," file evaluation is finished."]}),"\n",(0,r.jsxs)(n.p,{children:["Note ",(0,r.jsx)(n.code,{children:"write_package_value"})," symbol exists in ",(0,r.jsx)(n.code,{children:"bzl"})," globals, and it can be called\nfrom ",(0,r.jsx)(n.code,{children:"bzl"})," file in context of ",(0,r.jsx)(n.code,{children:"PACKAGE"})," evaluation, but calling\n",(0,r.jsx)(n.code,{children:"write_package_file"})," is an error on context of ",(0,r.jsx)(n.code,{children:"BUCK"})," evaluation."]}),"\n",(0,r.jsxs)(n.p,{children:["Modifying ",(0,r.jsx)(n.code,{children:"PACKAGE"})," file logically invalidates the ",(0,r.jsx)(n.code,{children:"BUCK"})," file of this\ndirectory, and all ",(0,r.jsx)(n.code,{children:"PACKAGE"})," and ",(0,r.jsx)(n.code,{children:"BUCK"})," files of sub-",(0,r.jsx)(n.code,{children:"PACKAGE"}),"s. However, ",(0,r.jsx)(n.code,{children:"BUCK"}),"\nfile evaluation may track which ",(0,r.jsx)(n.code,{children:"PACKAGE"}),"-local values were accessed and only\ninvalidate ",(0,r.jsx)(n.code,{children:"BUCK"})," files which were potentially affected (similarly to how we do\nit with buckconfigs)."]}),"\n",(0,r.jsx)(n.h4,{id:"read_parent_package_value",children:(0,r.jsx)(n.a,{href:"../../api/build#read_parent_package_value",children:(0,r.jsx)(n.code,{children:"read_parent_package_value"})})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"def read_parent_package_value(\n    key: str,\n): ...\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This global API is only available in ",(0,r.jsx)(n.code,{children:"PACKAGE"})," files, or ",(0,r.jsx)(n.code,{children:"bzl"})," files included in\n",(0,r.jsx)(n.code,{children:"PACKAGE"})," files."]}),"\n",(0,r.jsxs)(n.p,{children:["This function returns the ",(0,r.jsx)(n.code,{children:"PACKAGE"})," value defined in a parent ",(0,r.jsx)(n.code,{children:"PACKAGE"})," file, or\n",(0,r.jsx)(n.code,{children:"None"})," is such value does not exist."]}),"\n",(0,r.jsxs)(n.p,{children:["This function is available in ",(0,r.jsx)(n.code,{children:"PACKAGE"})," files, but attempt to call this function\nin context of ",(0,r.jsx)(n.code,{children:"bzl"})," file evaluation results in an error."]}),"\n",(0,r.jsx)(n.h4,{id:"package",children:(0,r.jsx)(n.a,{href:"../../api/build#package",children:(0,r.jsx)(n.code,{children:"package"})})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"def package(\n    inherit: bool = False,\n    visibility: list[str] | tuple[str, ...] = [],\n    within_view: list[str] | tuple[str, ...] = []\n) -> None\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This global API is only available in ",(0,r.jsx)(n.code,{children:"PACKAGE"})," files, or ",(0,r.jsx)(n.code,{children:"bzl"})," files included in\n",(0,r.jsx)(n.code,{children:"PACKAGE"})," files."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"visibility"})," is a list of visibility patterns to apply to all targets contained\nwithin the directory, unless the target defines it's own visibility patterns."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"within_view"})," is a list of visibility patterns restricting what all target\ncontained within the ",(0,r.jsx)(n.code,{children:"PACKAGE"})," directory can depend on. Applies to first-order\ndeps, and not transitive deps."]}),"\n",(0,r.jsxs)(n.p,{children:["If ",(0,r.jsx)(n.code,{children:"inherit"})," is ",(0,r.jsx)(n.code,{children:"True"}),", then the ",(0,r.jsx)(n.code,{children:"visibility"})," and ",(0,r.jsx)(n.code,{children:"within_view"})," will be\ninherited from the nearest parent ",(0,r.jsx)(n.code,{children:"PACKAGE"}),"."]}),"\n",(0,r.jsx)(n.h4,{id:"read_config",children:(0,r.jsx)(n.a,{href:"../../api/build#read_config",children:(0,r.jsx)(n.code,{children:"read_config"})})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"PACKAGE"})," files are able to call ",(0,r.jsx)(n.code,{children:"read_config"})," to read buckconfigs."]}),"\n",(0,r.jsxs)(n.h3,{id:"buck-specific-api",children:[(0,r.jsx)(n.code,{children:"BUCK"}),"-specific API"]}),"\n",(0,r.jsx)(n.h4,{id:"read_package_value",children:(0,r.jsx)(n.a,{href:"../../api/build#read_package_value",children:(0,r.jsx)(n.code,{children:"read_package_value"})})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"def read_package_value(\n    name: str,\n): ...\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This global API is only available in ",(0,r.jsx)(n.code,{children:"BUCK"})," files, or ",(0,r.jsx)(n.code,{children:"bzl"})," files included in\n",(0,r.jsx)(n.code,{children:"BUCK"})," files."]}),"\n",(0,r.jsxs)(n.p,{children:["This function returns the nearest ",(0,r.jsx)(n.code,{children:"name"})," value registered per ",(0,r.jsx)(n.code,{children:"PACKAGE"}),", or\n",(0,r.jsx)(n.code,{children:"None"})," is such value does not exist."]}),"\n",(0,r.jsxs)(n.p,{children:["This function is available in ",(0,r.jsx)(n.code,{children:"bzl"})," files, but attempt to call this function in\ncontext of ",(0,r.jsx)(n.code,{children:"PACKAGE"})," file evaluation results in an error. This restriction can\nbe lifted in the future."]})]})}function h(e={}){const{wrapper:n}={...(0,l.useMDXComponents)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},15680:(e,n,i)=>{i.r(n),i.d(n,{MDXContext:()=>d,MDXProvider:()=>u,mdx:()=>j,useMDXComponents:()=>h,withMDXComponents:()=>o});var r=i(96540);function l(e,n,i){return n in e?Object.defineProperty(e,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[n]=i,e}function c(){return c=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var i=arguments[n];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e},c.apply(this,arguments)}function a(e,n){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),i.push.apply(i,r)}return i}function s(e){for(var n=1;n<arguments.length;n++){var i=null!=arguments[n]?arguments[n]:{};n%2?a(Object(i),!0).forEach((function(n){l(e,n,i[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):a(Object(i)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(i,n))}))}return e}function t(e,n){if(null==e)return{};var i,r,l=function(e,n){if(null==e)return{};var i,r,l={},c=Object.keys(e);for(r=0;r<c.length;r++)i=c[r],n.indexOf(i)>=0||(l[i]=e[i]);return l}(e,n);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(r=0;r<c.length;r++)i=c[r],n.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(l[i]=e[i])}return l}var d=r.createContext({}),o=function(e){return function(n){var i=h(n.components);return r.createElement(e,c({},n,{components:i}))}},h=function(e){var n=r.useContext(d),i=n;return e&&(i="function"==typeof e?e(n):s(s({},n),e)),i},u=function(e){var n=h(e.components);return r.createElement(d.Provider,{value:n},e.children)},p="mdxType",f={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},x=r.forwardRef((function(e,n){var i=e.components,l=e.mdxType,c=e.originalType,a=e.parentName,d=t(e,["components","mdxType","originalType","parentName"]),o=h(i),u=l,p=o["".concat(a,".").concat(u)]||o[u]||f[u]||c;return i?r.createElement(p,s(s({ref:n},d),{},{components:i})):r.createElement(p,s({ref:n},d))}));function j(e,n){var i=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var c=i.length,a=new Array(c);a[0]=x;var s={};for(var t in n)hasOwnProperty.call(n,t)&&(s[t]=n[t]);s.originalType=e,s[p]="string"==typeof e?e:l,a[1]=s;for(var d=2;d<c;d++)a[d]=i[d];return r.createElement.apply(null,a)}return r.createElement.apply(null,i)}x.displayName="MDXCreateElement"}}]);