<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-rfcs/drafts/plugin-deps" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.1">
<title data-rh="true">plugin-deps | Buck2</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://buck2.build/docs/rfcs/drafts/plugin-deps/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="plugin-deps | Buck2"><meta data-rh="true" name="description" content="Plugin Deps"><meta data-rh="true" property="og:description" content="Plugin Deps"><link data-rh="true" rel="icon" href="/img/logo.png"><link data-rh="true" rel="canonical" href="https://buck2.build/docs/rfcs/drafts/plugin-deps/"><link data-rh="true" rel="alternate" href="https://buck2.build/docs/rfcs/drafts/plugin-deps/" hreflang="en"><link data-rh="true" rel="alternate" href="https://buck2.build/docs/rfcs/drafts/plugin-deps/" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GEGGHE39PE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-GEGGHE39PE",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.c6c35c65.css">
<script src="/assets/js/runtime~main.81f3685b.js" defer="defer"></script>
<script src="/assets/js/main.7a8cf8da.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Buck2 Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Buck2 Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Buck2</b></a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/docs/api/">API</a><a class="navbar__item navbar__link" href="/docs/prelude/globals/">Rules</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>plugin-deps</h1></header><h2 id="plugin-deps">Plugin Deps</h2>
<h3 id="background-on-rust-proc-macros">Background on Rust proc macros</h3>
<p>Rust proc macros are compiler plugins. They are a special kind of crate that is
compiled to a dylib, which is then loaded by the compiler when another crate
depends on the proc macro. Notably, like all Rust crates, proc macros may also
be re-exported. This means that if there is a dependency chain like
<code>bin -&gt; lib -&gt; proc_macro</code>, the proc macro must be made available when compiling
the binary, even though it does not appear directly in the dependencies.</p>
<p>Proc macros have posed a challenge to buck2, for two reasons:</p>
<ol>
<li>Rust users generally expect to not have to distinguish between proc macros
and normal crates when specifying their dependencies. This means it is not
easily possible to make the <code>lib -&gt; proc_macro</code> edge an <code>exec_dep</code>.</li>
<li><code>bin</code> and <code>lib</code> might end up with different exec platforms. This means that
even if <code>proc_macro</code> were to be correctly configured as an exec dep of
<code>lib</code>, that configuration might be wrong for <code>bin</code>.</li>
</ol>
<p>FIXME: Other use cases for this feature</p>
<h3 id="plugins-deps">Plugins deps</h3>
<p>This RFC proposes introducing a concept of &quot;plugin deps&quot; to solve this problem.
Plugin deps are deps that can be propagated up the build graph at configuration
time, instead of at analysis time. Here&#x27;s what this looks like:</p>
<p>First, plugin deps come in &quot;kinds.&quot; Plugin kinds can be created like
<code>MyKind = plugins.kind()</code>. These act as identifiers that can be used to divide
all the possible plugin deps up however users need to.</p>
<p>Each configured target has plugin lists: There is one list for each plugin kind.
The elements of these list are an <em>unconfigured</em> target, together with a
<code>should_propagate</code> bool. The same unconfigured target cannot appear more than
once. In other words, this is a <code>HashMap&lt;String, HashMap&lt;Target, bool&gt;&gt;</code>. We
need to describe two things: How to <em>use</em> these list, and how to <em>create</em> them.</p>
<h3 id="using-a-targets-plugin-lists">Using a target&#x27;s plugin lists</h3>
<p>Using plugin lists is very simple: The rule sets <code>uses_plugins = [MyKind]</code> when
declared. Setting this make the elements of the plugin list for the given kind
appear as exec deps on the configured nodes for this rule. This also means that
the plugins participate in exec dep resolution like all other exec deps.</p>
<p>Analysis will then be able to access a list of the providers for each of the
plugins via <code>ctx.plugins[MyKind]</code>.</p>
<p>The <code>should_propagate</code> bool that is associated with each element of the list is
ignored at this stage.</p>
<h3 id="creating-a-targets-plugin-lists">Creating a target&#x27;s plugin lists</h3>
<p>Plugin lists are created by accumulating from two sources:</p>
<p>The first of these is direct plugin deps. They are defined via a new
<code>attrs.plugin_dep(kind = &quot;foo&quot;)</code>. This attribute (like other deps), is set to a
label when the target is declared. It then resolves as follows:</p>
<ul>
<li>In the unconfigured graph: To the appropriate unconfigured target</li>
<li>In the configured graph: To the label of the unconfigured target. In other
words, this will still be displayed in <code>buck2 cquery -A</code>, but will not appear
in the deps.</li>
<li>During analysis: Also to the unconfigured target label.</li>
</ul>
<p>The target that appears in the <code>plugin_dep</code> is added to the <code>MyKind</code> plugin list
with <code>should_propagate</code> set.</p>
<p>The second way to add to the plugin list is by inheriting from regular deps.
This works as follows: Elements of the plugin lists for which the
<code>should_propagate</code> value is true are made available to the immediate rdeps of a
configured target. The rdep can use them by setting <code>pulls_plugins = [MyKind]</code>
in the appropriate <code>attrs.dep()</code> invocation. This will make the targets appear
in the plugin list for the rdep with <code>should_propagate</code> unset. Alternatively,
the rdep can set <code>pulls_and_pushes_plugins = [MyKind]</code> to add the targets to the
plugin lists with <code>should_propagate</code> set to true. This enables transitive
propagation further up the configured graph.</p>
<p>To decide later: Should we allow plugin rules to appear in regular/exec deps,
with no special behavior? I don&#x27;t see why not.</p>
<h3 id="example-proc-macros">Example: Proc macros</h3>
<pre><code class="language-py">RustProcMacro = plugins.kind()

rust_proc_macro_propagation = rule(
    impl = _propagation_impl,
    attrs = {
        &quot;actual&quot;: attrs.plugin_dep(kind = RustProcMacro),
    },
)

rust_library = rule(
    impl = _similar_to_before, # See some notes below
    attrs = {
        &quot;proc_macro&quot;: attrs.bool(default = False),  # Same as before
        &quot;deps&quot;: attrs.list(attrs.dep(pulls_and_pushes_plugins = [RustProcMacro])),
        # Here we avoid `pulls_and_pushes` because we do not want to make these deps available to rdeps
        &quot;doc_deps&quot;: attrs.list(attrs.dep(pulls_plugins = [RustProcMacro])),
    },
    uses_plugins = [RustProcMacro]
)

rust_binary = rule(
    impl = _similar_to_before, # See some notes below
    attrs = {
        &quot;deps&quot;: attrs.list(attrs.dep(pulls_plugins = [RustProcMacro])),
        &quot;doc_deps&quot;: attrs.list(attrs.dep(pulls_plugins = [RustProcMacro])),
    },
    uses_plugins = [RustProcMacro]
)

def _propagation_impl(ctx):
    return [
        DefaultInfo(default_outputs = []),
        # During analysis for rust libraries, the providers for proc macros will appear in
        # `ctx.plugins`. However, this includes the transitive and direct proc macro deps, as
        # well as the transitive and direct proc macro doc-deps. Analysis needs to be able to
        # distinguish between all of these though.
        #
        # This dummy provider is passed to allow for precisely that. Generally, it will be passed
        # everywhere where the providers of Rust proc macros are currently passed. That ensures that
        # analysis on `rust_library` and `rust_binary` have all the information they need about
        # where the plugin &quot;entered the dependency graph.&quot;
        RustProcMacroMarker(ctx.attrs.actual),
    ]

### TARGETS

# Expanded by macro
rust_library(
    name = &quot;p1_REAL&quot;,
    proc_macro = True,
)

# Expanded by macro
rust_proc_macro_propagation(
    name = &quot;p1&quot;,
    actual = &quot;:p1_REAL&quot;,
)

# Expanded by macro
rust_library(
    name = &quot;p2_REAL&quot;,
    proc_macro = True,
)

# Expanded by macro
rust_proc_macro_propagation(
    name = &quot;p2&quot;,
    actual = &quot;:p2_REAL&quot;,
)

rust_library(
    name = &quot;l&quot;,
    deps = [&quot;:p1&quot;],
    doc_deps = [&quot;:p2&quot;],
)

rust_binary(
    name = &quot;b&quot;,
    deps = [&quot;:l&quot;],
)
</code></pre>
<p>Analysis for <code>:l</code> will see:</p>
<ol>
<li><code>deps</code> which contains only the <code>RustProcMacroMarker(&quot;p&quot;)</code></li>
<li><code>doc_deps</code> which contains only the <code>RustProcMacroMarker(&quot;p2&quot;)</code></li>
<li><code>ctx.plugins[RustProcMacro]</code> which contains the providers of <code>:p1_REAL</code> and
<code>:p2_REAL</code>, correctly configured for the execution platform of <code>:l</code>.</li>
</ol>
<p>Analysis for <code>:b</code> will see:</p>
<ol>
<li>
<p><code>deps</code> which contain the providers of <code>l</code></p>
</li>
<li>
<p><code>ctx.plugins[RustProcMacro]</code> which contain the providers of <code>:p1_REAL</code>, also
correctly configured for its own execution platform (which may be different
from <code>:l</code>&#x27;s).</p>
<p>Note that because <code>rust_library</code> does not re-push doc deps, <code>:b</code> will not
see <code>:p2_REAL</code>.</p>
</li>
</ol>
<p>As a result, the implementation of the <code>rust_library</code> rule should not propagate
the providers of its proc macro deps (unlike its regular deps).</p>
<p>There is one downside to this solution: <code>buck2 build :p</code> does absolutely none of
the things that the user is probably expecting. They need <code>buck2 build :p_REAL</code>.
That&#x27;s a bit sad. Thankfully directly building proc macros is not that important
a use case?</p>
<h4 id="alias">Alias</h4>
<p>It is already the case today that we can&#x27;t use the normal <code>alias</code> rule on
toolchains. A similar situation crops up here, where aliasing a target that
pushes plugins causes the plugins to &quot;get lost.&quot; The right solution to this is
to probably allow <code>plugins.ALL</code> as a special value on <code>pulls_plugins</code> and
<code>pulls_and_pushes_plugins</code>, and then set that for the alias rule.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#plugin-deps" class="table-of-contents__link toc-highlight">Plugin Deps</a><ul><li><a href="#background-on-rust-proc-macros" class="table-of-contents__link toc-highlight">Background on Rust proc macros</a></li><li><a href="#plugins-deps" class="table-of-contents__link toc-highlight">Plugins deps</a></li><li><a href="#using-a-targets-plugin-lists" class="table-of-contents__link toc-highlight">Using a target&#39;s plugin lists</a></li><li><a href="#creating-a-targets-plugin-lists" class="table-of-contents__link toc-highlight">Creating a target&#39;s plugin lists</a></li><li><a href="#example-proc-macros" class="table-of-contents__link toc-highlight">Example: Proc macros</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/">User guide</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/terms" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>