<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-rule_authors/writing_rules" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.1">
<title data-rh="true">Writing Rules | Buck2</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://buck2.build/docs/rule_authors/writing_rules/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Writing Rules | Buck2"><meta data-rh="true" name="description" content="This page describes how to write rules for Buck2 and explains the flow for"><meta data-rh="true" property="og:description" content="This page describes how to write rules for Buck2 and explains the flow for"><link data-rh="true" rel="icon" href="/img/logo.png"><link data-rh="true" rel="canonical" href="https://buck2.build/docs/rule_authors/writing_rules/"><link data-rh="true" rel="alternate" href="https://buck2.build/docs/rule_authors/writing_rules/" hreflang="en"><link data-rh="true" rel="alternate" href="https://buck2.build/docs/rule_authors/writing_rules/" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GEGGHE39PE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-GEGGHE39PE",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.c6c35c65.css">
<script src="/assets/js/runtime~main.81f3685b.js" defer="defer"></script>
<script src="/assets/js/main.7a8cf8da.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Buck2 Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Buck2 Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Buck2</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/docs/api/">API</a><a class="navbar__item navbar__link" href="/docs/prelude/globals/">Rules</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/about/why/">About Buck2</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/concepts/key_concepts/">Concepts</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/users/commands/aquery/">Buck2 Users</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/rule_authors/writing_rules/">Rule Authors</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/rule_authors/writing_rules/">Writing Rules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/transitive_sets/">Transitive Sets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/configurations/">Configurations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/configuration_transitions/">Configuration Transitions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/dynamic_dependencies/">Dynamic Dependencies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/anon_targets/">Anonymous Targets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/test_execution/">Test Execution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/optimization/">Observability and Optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/incremental_actions/">Incremental Actions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/alias/">Alias</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/local_resources/">Local Resources For Tests Execution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/package_files/">PACKAGE Files</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/dep_files/">Dep Files</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/developers/bxl/">BXL Developers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/developers/architecture/buck2/">Buck2 Developers</a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Rule Authors</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Writing Rules</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Writing Rules</h1></header><p>This page describes how to write rules for Buck2 and explains the flow for
implementing rules that are already defined in Buck1.</p>
<p>For a list of the API functions available, see the
<a href="../../api/build">Build APIs</a>.</p>
<admonition type="note"><p>Rules such as <code>@fbcode_macros//build_defs:native_rules.bzl buck_genrule</code> are not actually rules, they are <em>macros</em> (Starlark functions that eventually call out the underlying <code>genrule</code> <em>rule</em>). Macros in Buck2 are mostly compatible with Buck1 and should be written in the same way.</p></admonition>
<h2 id="workflow-by-example">Workflow by example</h2>
<p>The built-in Buck2 rules are stored in the <code>prelude</code> folder in the buck2 repo.
To add a rule for a language, say <code>pascal</code>:</p>
<ol>
<li>
<p>Look at
<a href="https://github.com/facebook/buck2/blob/main/prelude/decls/">prelude/decls</a>
to see the attributes that are supported in Buck1 and are mirrored into
Buck2. If <code>pascal</code> was an existing rule, you would see what attributes it
takes (often it will be <code>pascal_library</code> and <code>pascal_binary</code>).</p>
</li>
<li>
<p>Create a file <code>pascal.bzl</code> that will contain your rule implementations. The
details are explained later, but a dummy rule looks like the following:</p>
<pre><code class="language-python">def pascal_binary_impl(_ctx: AnalysisContext) -&gt; list[Provider]:
    return [DefaultInfo()]
</code></pre>
</li>
<li>
<p>Create a directory in <code>fbcode/buck2/tests/targets/rules/pascal</code> with
<code>TARGETS</code> and whatever source files and test targets you need to test your
project. Note, Apple tests are currently located at
<code>xplat/buck2/tests/apple/...</code>.</p>
</li>
<li>
<p>Test your code with <code>buck2 build fbcode//buck2/tests/targets/rules/pascal:</code>.
They should succeed with no actual output produced.</p>
</li>
<li>
<p>Now implement the rules (see the rest of this page).</p>
</li>
</ol>
<admonition type="note"><p>Before merging a diff, it&#x27;s important that all your Starlark is warning free (if you don&#x27;t want to set up Buck2 for local development, test it in CI). </p></admonition>
<h2 id="concepts-and-design">Concepts and design</h2>
<p>A <em>rule</em> for a <em>target</em> uses <em>attributes</em> to declare <em>actions</em>, which produce
<em>artifacts</em> that get included in <em>providers</em>.</p>
<p>For example, given:</p>
<pre><code class="language-python">def pascal_binary_impl(ctx: AnalysisContext) -&gt; list[Provider]:
    ...
    binary = ctx.actions.declare_output(ctx.attrs.out)
    ctx.actions.run([&quot;pascalc&quot;, ctx.attrs.srcs, &quot;-o&quot;, binary.as_output()])
    return [
        DefaultInfo(default_output = binary),
    ]

pascal_binary = rule(impl = pascal_binary_impl, attrs = {
  &quot;out&quot;: attrs.string(),
  ...
})
</code></pre>
<p>In the above snippet:</p>
<ul>
<li><strong>Rule</strong> is <code>pascal_binary</code>, which is implemented by <code>pascal_binary_impl</code>. The
rule says how to build things.</li>
<li><strong>Target</strong> will be something like
<code>fbcode//buck2/tests/targets/rules/pascal:my_binary</code>. The rule implementation
<code>pascal_binary_impl</code> will be called once per target.</li>
<li><strong>Attributes</strong> are the fields on the target (for example, you might have
<code>out</code>, which can be accessed via <code>ctx.attrs.out</code>).</li>
<li><strong>Actions</strong> are declared by the rule with things like <code>ctx.actions.run</code>, which
takes a command line. Note that the actions are not run by the rule, but
declared, so that Buck2 can run them later.</li>
<li><strong>Artifacts</strong> represent files on disk, which could be source or build outputs
(<code>binary</code> in the above example).<!-- -->
<ul>
<li>For build outputs, the artifact is produced by an action, and the existence
of the artifact does not imply the build has been run: the artifact
&#x27;remembers&#x27; what should be run if it is required.</li>
</ul>
</li>
<li><strong>Providers</strong> are returned, which is information that other rules get to use.
These will often contain artifacts.</li>
</ul>
<p>The rule implementation takes in a <code>ctx</code>, which is the rule context. The two
most important fields are <code>ctx.attrs</code>, which picks up the attributes declared by
the rule, and <code>ctx.actions</code>, which lets you create new actions to actually do
something.</p>
<p>The output of any actions performed will be materialized in <code>buck-out</code>. However,
only the defined outputs of providers are available for dependent rules to
consume and only the actions necessary to produce those outputs being consumed
will be run. By default, the <code>default_output</code> of the <code>DefaultInfo</code> provider is
built and output during a <code>buck build</code>.</p>
<h3 id="providers">Providers</h3>
<p>Providers are the data returned from a rule and are the only way that
information from this rule is available to rules that depend on it. Every rule
must return at least the <code>DefaultInfo</code> provider, but most will also return
either <code>RunInfo</code> (because they are executable) or some custom provider (because
they are incorporated into something that is ultimately executable).</p>
<p>The <code>DefaultInfo</code> provider has a field <code>default_output</code>, which is the file that
will be built when someone executes a <code>buck2 build</code> on this particular target,
and the file that will be used when someone runs <code>$(location target)</code> or uses it
as a source file (such as <code>srcs = [&quot;:my_target&quot;]</code>.)</p>
<p>The current rule of thumb is that if you can build the <code>default_output</code>, the
rule must &#x27;work&#x27;, and, if usable, should be &#x27;ready&#x27;. For example, for a binary,
the executable and runtime libraries it depends on might be returned. For a
library, because neither the static or dynamic library is the &#x27;default&#x27;, you
merely have to do enough work to ensure that the static and dynamic library
probably work.</p>
<p>Similar to how <code>DefaultInfo</code> wraps a list of artifacts and <code>$(location)</code> selects
from <code>DefaultInfo</code>, <code>RunInfo</code> wraps a command line and <code>$(exe)</code> selects from
<code>RunInfo</code>.</p>
<p>For more information about command lines, see <a href="#run-action">Run action</a>, below.</p>
<p>For libraries, usually you need to pass some information about the library up to
the binary. The <em>only</em> information that dependents on the library get are the
providers, so designing the information that flows around the provider is
critical to designing good rules.</p>
<p>For a hypothetical rule, you may decide you want the name of the library and the
artifact that represents the <code>.so</code> file, for which you could define the
following provider:</p>
<pre><code class="language-python">PascalLibraryInfo = provider(fields=[
    &quot;name&quot;,   # The name of the library
    &quot;object&quot;  # An artifact, the .so file that needs linking in
    ]
)
</code></pre>
<p>Often, you&#x27;ll grab your dependencies from all your providers:</p>
<pre><code class="language-python">my_deps = [x[PascalLibraryInfo] for x in ctx.attrs.deps]
</code></pre>
<p>In many cases, it becomes apparent you need the transitive closure of all
libraries (for example, the libraries and everything they depend upon), in which
case, the standard pattern is to move to a provider of a list of <code>record</code> (see
the
<a href="https://github.com/facebook/starlark-rust/blob/main/docs/types.md">types.md</a>
document in GitHub) and the <code>flatten/dedupe</code> functions, defining it as:</p>
<pre><code class="language-python">PascalLibraryInfo = provider(fields=[&quot;links&quot;]) # a list of LinkData

LinkData = record(name = str, object = &quot;artifact&quot;)
</code></pre>
<p>And then consuming it:</p>
<pre><code class="language-python">my_links = dedupe(flatten([x[PascalLibraryInfo].links for x in ctx.attrs.deps]))
my_info = PascalLibraryInfo(links = my_links)
</code></pre>
<p>However, this <code>flatten</code>/<code>dupe</code> pattern can get expensive, especially when you
have a deep dependency graph. To fix that it&#x27;s recommended to use
<a href="/docs/rule_authors/transitive_sets">transitive sets</a>.</p>
<h3 id="actions">Actions</h3>
<p>There are several actions you can use to create symlink trees, and so on.</p>
<h4 id="run-action">Run action</h4>
<p>Of the various actions, the <code>run</code> action is by far the most important: it&#x27;s the
one that invokes a command line.</p>
<p>A command line is both a list of string arguments and a list of artifacts they
depend on; with syntactic niceties for adding artifacts to command lines in a
way that ensures the dependencies are usually correct.</p>
<p>Following are examples of command line manipulations:</p>
<pre><code class="language-python">cmd = cmd_args([&quot;some&quot;, &quot;arguments&quot;])
cmd.add(&quot;another-arg&quot;)
cmd.add(ctx.attrs.src) # An input artifact
out = ctx.actions.declare_output(&quot;an output&quot;)
cmd.add(out.as_output())
ctx.actions.run(cmd)
</code></pre>
<p>The action <code>declare_output</code> creates a new artifact which is not bound to
anything. You can call <code>.as_output()</code> on it when adding it to a command line to
say that this command line doesn&#x27;t take the artifact as an input but produces it
as an output.</p>
<p>From now on, if <code>out</code> is used as a dependency (either to another command line,
or in <code>DefaultInfo</code>) then the action will be run to produce that artifact.
Typically, these outputs are declared (<code>declare_output</code>), bound in a
<code>ctx.actions.run</code> call with <code>.as_output()</code>, then either used locally as the
input to another action or returned in a provider.</p>
<p>As another example:</p>
<pre><code class="language-python">cmd = cmd_args([&quot;cp&quot;, input, output.as_output()])
ctx.actions.run(cmd)
</code></pre>
<p>A command provides both a string (what to write when used) and a list of
artifacts (what must be available when used). Normally, as in the case above,
the artifacts that are used correspond to those on the command line. But imagine
the rule is changed to write the command to a shell script first:</p>
<pre><code class="language-python">sh = ctx.actions.write(&quot;test.sh&quot;, [&quot;cp&quot;, input, output])
cmd = cmd_args([&quot;sh&quot;,sh],hidden=[input, output.as_output()])
ctx.actions.run(cmd)
</code></pre>
<p>The command has been written to a shell script, which is now run. Beforehand,
all the artifacts used by the command appeared on the command line. Now they
don&#x27;t. However, the shell script still accesses input and output. To inform the
run command, use the hidden field of the command line to declare the dependency.</p>
<p>For more complicated actions, which perform meaningful logic beyond invoking a
simple command, the tendency is to write custom Python scripts. Python scripts
are used instead of shell scripts as they have better cross-platform
compatibility and fewer hidden corners (especially in error paths).</p>
<p>As an example of a Python helper, see
<a href="https://github.com/facebook/buck2/blob/main/prelude/cxx/tools/make_comp_db.py">make_comp_db.py</a>.</p>
<p>A further advantage of using Python is that these commands can be tested in
isolation, outside of Buck2.</p>
<h2 id="debugging">Debugging</h2>
<p>The functions <code>fail</code>, <code>print</code> and <code>pprint</code> are your friends. To get started, a
<code>buck2 build fbcode//buck2/tests/targets/rules/pascal:</code> builds everything or
<code>buck2 run fbcode//buck2/tests/targets/rules/pascal:my_binary</code> runs a specific
binary that returns a <code>RunInfo</code>.</p>
<h2 id="testing-rules">Testing Rules</h2>
<p>A common way to test is to use <code>genrule</code> to cause the produced binary to run and
assert some properties from it. If your rule is in Buck1 and Buck2, use a
<code>TARGETS</code> file so you can test with both. If your tests are incompatible with
Buck1 (such as if it is a new rule), use <code>TARGETS.v2</code>, which will only be seen
by Buck2 and won&#x27;t cause errors with Buck1.</p>
<h2 id="new-rules">New rules</h2>
<p>If your rule is <strong>not</strong> already in Buck1, then you can define it wherever you
like, with a preference for it not being in <code>fbcode/buck2/prelude</code>.</p>
<p>The only advantage of the <code>prelude</code> is that rules can be used without a
corresponding <code>load</code>, which is generally considered a misfeature. The attributes
should usually be placed adjacent to the rule itself.</p>
<p>As an example, just below the <code>pascal_binary_impl</code> function, you could write:</p>
<pre><code class="language-python">pascal_binary = rule(
    impl = pascal_binary_impl,
    attrs = {
        &quot;deps&quot;: attrs.list(attrs.dep()),
        &quot;src&quot;: attrs.source(),
    }
)
</code></pre></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/users/advanced/external_cells/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">External Cells</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/rule_authors/transitive_sets/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Transitive Sets</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#workflow-by-example" class="table-of-contents__link toc-highlight">Workflow by example</a></li><li><a href="#concepts-and-design" class="table-of-contents__link toc-highlight">Concepts and design</a><ul><li><a href="#providers" class="table-of-contents__link toc-highlight">Providers</a></li><li><a href="#actions" class="table-of-contents__link toc-highlight">Actions</a></li></ul></li><li><a href="#debugging" class="table-of-contents__link toc-highlight">Debugging</a></li><li><a href="#testing-rules" class="table-of-contents__link toc-highlight">Testing Rules</a></li><li><a href="#new-rules" class="table-of-contents__link toc-highlight">New rules</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/">User guide</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/terms" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>