<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-rule_authors/anon_targets" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.1">
<title data-rh="true">Anonymous Targets | Buck2</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://buck2.build/docs/rule_authors/anon_targets/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Anonymous Targets | Buck2"><meta data-rh="true" name="description" content="An anonymous target is defined by the hash of its attributes, rather than its"><meta data-rh="true" property="og:description" content="An anonymous target is defined by the hash of its attributes, rather than its"><link data-rh="true" rel="icon" href="/img/logo.png"><link data-rh="true" rel="canonical" href="https://buck2.build/docs/rule_authors/anon_targets/"><link data-rh="true" rel="alternate" href="https://buck2.build/docs/rule_authors/anon_targets/" hreflang="en"><link data-rh="true" rel="alternate" href="https://buck2.build/docs/rule_authors/anon_targets/" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GEGGHE39PE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-GEGGHE39PE",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.c6c35c65.css">
<script src="/assets/js/runtime~main.81f3685b.js" defer="defer"></script>
<script src="/assets/js/main.7a8cf8da.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Buck2 Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Buck2 Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Buck2</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/docs/api/">API</a><a class="navbar__item navbar__link" href="/docs/prelude/globals/">Rules</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/about/why/">About Buck2</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/concepts/key_concepts/">Concepts</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/users/commands/aquery/">Buck2 Users</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/rule_authors/writing_rules/">Rule Authors</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/writing_rules/">Writing Rules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/transitive_sets/">Transitive Sets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/configurations/">Configurations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/configuration_transitions/">Configuration Transitions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/dynamic_dependencies/">Dynamic Dependencies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/rule_authors/anon_targets/">Anonymous Targets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/test_execution/">Test Execution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/optimization/">Observability and Optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/incremental_actions/">Incremental Actions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/alias/">Alias</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/local_resources/">Local Resources For Tests Execution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/package_files/">PACKAGE Files</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rule_authors/dep_files/">Dep Files</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/developers/bxl/">BXL Developers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/developers/architecture/buck2/">Buck2 Developers</a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Rule Authors</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Anonymous Targets</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><p>An anonymous target is defined by the hash of its attributes, rather than its
name. During analysis, rules can define and access the providers of anonymous
targets before producing their own providers. Two distinct rules might ask for
the same anonymous target, sharing the work it performs.</p>
<p>This solves two distinct problems:</p>
<ul>
<li><strong>The sharing problem</strong> - if you have two processes that want to share some
work, you can create an anon target that does that work once, which is then
reused by the two processes. Without such a mechanism, all sharing must be
present in the target graph: you can&#x27;t create any new sharing.</li>
<li><strong>The overlay problem</strong> - this is the idea that you want to have a
shadow-graph, similar in structure to the normal graph, but with additional
information attached. Bazel accomplishes this with
<a href="https://bazel.build/extending/aspects">Aspects</a>. With Anonymous (anon)
targets, you can create a shadow-graph by convention, just by using the target
name you wish to shadow as the attribute.</li>
</ul>
<p>Dynamic dependencies, in their full generality, enable users to do a thing, look
at the result, then ask for fresh things. However, this full generality is not
provided as it breaks processes, like query, that power the Target Determinator.</p>
<p>In Buck2, dynamic dependencies are implemented using <code>dynamic_output</code>, which
provides users with the ability to create new actions, after running actions,
then look at the result. <code>dynamic_output</code> is restricted in its power when
compared to fully generic dynamic dependencies, as detailed in the
<a href="/docs/rule_authors/dynamic_dependencies">Dynamic Dependencies</a> page.</p>
<p>Anon targets enable users to create a new analysis (that is, call an anon target
that may not have existed before) after looking at the result of a previous
analysis (which is passed in, or after looking at an anon target). In many ways,
anon target is the version of <code>dynamic_output</code> at analysis time, rather than
action time.</p>
<p>The execution platform for an anon target is that of the inherited from the
calling target, which is part of the hash. If that is too restrictive, you could
use execution groups, where an anon target gets told which execution group to
use.</p>
<header><h1 id="creating-anon-targets">Creating anon targets</h1></header>
<h2 id="anon-rule">Anon rule</h2>
<p>An anonymous rule is defined using <code>rule</code> or <code>anon_rule</code>.</p>
<p>Example:</p>
<pre><code class="language-python">my_anon_rule = rule(
    impl = _anon_impl,
    attrs = {},
)

# Or:

my_anon_rule = anon_rule(
    impl = _anon_impl,
    attrs = {},
    artifact_promise_mappings = {} # only available for anon_rule
)
</code></pre>
<p>For <code>rule</code>, these are normal rules, with the difference that they are not in a
configuration, so <code>ctx.actions.label</code> won&#x27;t show configuration information, but
just <code>unspecified</code>.</p>
<p>For <code>anon_rule</code>, the configuration restrictions also apply, and there is an
<code>artifact_promise_mappings</code> field which you can specify a dict of artifact
promise names to the map function, which would be applied to the anon target&#x27;s
promise during rule resolution.</p>
<h2 id="anon-target">Anon target</h2>
<p>An anonymous rule is used via <code>ctx.actions.anon_target</code> or
<code>ctx.actions.anon_targets</code>, passing in the rule and the attributes for the rule.</p>
<p>The return values of those functions are a <code>AnonTarget</code> and <code>AnonTargets</code> type,
respectively.</p>
<p>Example:</p>
<pre><code class="language-python">my_anon_rule1 = anon_rule(
    impl = _anon_impl,
    attrs = {},
    artifact_promise_mappings = {}
)

my_anon_rule2 = anon_rule(
    impl = _anon_impl,
    attrs = {},
    artifact_promise_mappings = {}
)

# &lt;elsewhere&gt;
anon_target = ctx.actions.anon_target(my_anon_rule1, {})

anon_targets = ctx.actions.anon_targets([(my_anon_rule1, {}), (my_anon_rule2, {})])
</code></pre>
<h3 id="anontarget-and-anontargets"><code>AnonTarget</code> and <code>AnonTargets</code></h3>
<p><code>AnonTarget</code> has a <code>promise</code> attribute, and <code>artifact()</code> and <code>artifacts()</code>
functions. <code>AnonTargets</code> has a <code>promise</code> attribute and <code>anon_targets</code> attribute.</p>
<p>The <code>promise</code> attribute for both types returns the anon target&#x27;s promise (type
is <code>promise</code>), which when evaluated returns the providers of the anonymous
target. The <code>promise</code> type has a few special behaviors.</p>
<ul>
<li>It has a <code>map</code> function, which takes a function and applies it to the future,
returning a new future</li>
<li>All promises will eventually resolve to a list of providers</li>
</ul>
<p>For <code>AnonTarget</code>, the <code>artifact()</code> and <code>artifacts()</code> functions only return
something if using <code>anon_rule</code>. <code>artifact()</code> takes in an artifact name, which
should be found in the <code>artifact_promise_mappings</code> dict, and returns the
artifact promise. <code>artifacts()</code> returns the dict of all promise artifact names
to the artifact promise itself, as defined in <code>artifact_promise_mappings</code>. See
<a href="#convert-promise-to-artifact">Convert promise to artifact</a> below for more
information about artifact promises.</p>
<p>Example:</p>
<pre><code class="language-python">HelloInfo = provider(fields = [&quot;output&quot;])

my_anon_rule = anon_rule(
    impl = _anon_impl,
    attrs = {},
    artifact_promise_mappings = {
        &quot;hello&quot;: lambda x: x[HelloInfo].output,
    }
)

# &lt;elsewhere&gt;
anon_target = ctx.actions.anon_target(my_anon_rule, {})
artifact = anon_target.artifact(&quot;hello&quot;)
artifact_from_dict = anon_target.artifacts()[&quot;hello&quot;]
</code></pre>
<p>For <code>AnonTargets</code>, the <code>anon_targets</code> attribute returns a list of the underlying
<code>AnonTarget</code>s.</p>
<p>Example:</p>
<pre><code class="language-python">HelloInfo = provider(fields = [&quot;output&quot;])
GoodbyeInfo = provider(fields = [&quot;output&quot;])

my_anon_rule1 = anon_rule(
    impl = _anon_impl,
    attrs = {},
    artifact_promise_mappings = {
        &quot;hello&quot;: lambda x: x[HelloInfo].output,
    }
)

my_anon_rule2 = anon_rule(
    impl = _anon_impl,
    attrs = {},
    artifact_promise_mappings = {
        &quot;goodbye&quot;: lambda x: x[GoodbyeInfo].output,
    }
)

# &lt;elsewhere&gt;
all_targets = ctx.actions.anon_targets([(my_anon_rule1, {}), (my_anon_rule2, {})])
hello = all_targets.anon_targets[0].artifact(&quot;hello&quot;)
goodbye = all_targets.anon_targets[1].artifact(&quot;goodbye&quot;)
</code></pre>
<h1 id="attributes">Attributes</h1>
<p>Anon targets only support a subset of attributes that normal rules support.</p>
<p>Supported attributes:</p>
<ul>
<li><code>bool</code></li>
<li><code>int</code></li>
<li><code>str</code></li>
<li><code>enum</code></li>
<li><code>dep</code>
<ul>
<li><code>deps</code> attributes do not take strings, but dependencies, already in a
configuration</li>
<li><code>exec_deps</code> are available if the passed in <code>dep</code>&#x27;s execution platform
matches</li>
<li>Default <code>attr.deps</code> (as used for toolchains) are not permitted, as the
default can&#x27;t express a dependency. They must be passed forward from the
caller. that of the anon target&#x27;s caller</li>
</ul>
</li>
<li><code>source</code>
<ul>
<li>Accepts bound artifacts or promise artifacts</li>
</ul>
</li>
<li><code>arg</code>
<ul>
<li>Can only be used if <code>anon_target_compatible</code> is <code>True</code> when declaring
<code>attrs.arg</code> (ex: <code>attrs.arg(anon_target_compatible = True)</code>)</li>
</ul>
</li>
<li><code>label</code></li>
<li><code>list</code></li>
<li><code>tuple</code></li>
<li><code>dict</code></li>
<li><code>one_of</code></li>
<li><code>option</code></li>
</ul>
<p>You can use these attributes like you would in normal rules:</p>
<pre><code class="language-python">my_anon_rule = anon_rule(
    impl = _my_anon_impl,
    attrs = {
        &quot;my_int&quot;: attrs.int(),
        &quot;my_string_with_default&quot;: attrs.string(default = &quot;foo&quot;),
        &quot;my_optional_source&quot;: attrs.option(attrs.source()),
        &quot;my_list_of_labels&quot;: attrs.list(attrs.label()),
    },
    artifact_promise_mappings = {}
)

def _my_anon_impl(ctx: AnalysisContext) -&gt; list[Provider]:
    my_int = ctx.attrs.my_int
    my_string_with_default = ctx.attrs.my_string_with_default
    my_optional_source = ctx.attrs.my_optional_source
    my_list_of_labels = ctx.attrs.my_list_of_labels

    # do something with the attributes...

    return [DefaultInfo()]
</code></pre>
<h2 id="attribute-resolution">Attribute resolution</h2>
<p>Attribute resolution is handled differently from normal code:</p>
<ul>
<li>Transitions and more complex forms of attributes are banned.</li>
<li>The <code>name</code> attribute is a reserved attribute. It is an implicit attribute when
defining a rule for an anon target, but can be optionally set when creating an
anon target. If present, it must be a syntactically valid target, but could
refer to a cell/package that does not exist. If not present, buck2 will
generate a name for the target automatically.</li>
</ul>
<h3 id="name-attribute-example"><code>name</code> attribute example</h3>
<pre><code class="language-python"># Rule definition for anon target
my_rule = rule(
    impl = _my_impl,
    attrs = {
        # `name` is already implicitly defined as an attribute, and will error
        # out if you try to define it again during rule declaration
    },
)

# Anon target instantiation, elsewhere
 ctx.actions.anon_target(
    my_rule,
    {
        # you can optionally pass `name` into the attributes even though it&#x27;s
        # not explicitly defined in the `attrs` field for `my_rule`
        &quot;name&quot;: &quot;foo//bar:baz&quot;
    },
)
</code></pre>
<p>To access the <code>name</code> attribute from an analysis context, you can use
<code>ctx.label.name</code>.</p>
<h1 id="examples">Examples</h1>
<h2 id="simple-example">Simple Example</h2>
<pre><code class="language-python"># Define an anonymous rule
UpperInfo = provider(fields = [&quot;message&quot;])

def _impl_upper(ctx):
    return [UpperInfo(message = ctx.attrs.message.upper()]

upper = rule(
    attrs = {&quot;message&quot;, attrs.string()},
    impl = _impl_upper
)

# Use an anonymous target
def impl(ctx):
    def k(providers):
        print(providers[UpperInfo].message)
        # These are the providers this target returns
        return [DefaultInfo()]
    return ctx.actions.anon_target(upper, {
        name: &quot;my//:greeting&quot;,
        message: &quot;Hello World&quot;,
    })
    .promise
    .map(k)
</code></pre>
<h2 id="longer-example">Longer example</h2>
<p>The following code represents a scenario for a compile-and-link language where,
if two targets end up compiling the same file (for example, they are in the same
package and both list it, or it gets export_file&#x27;d), then that file is compiled
just once:</p>
<pre><code class="language-python">## BUCK ##############
@load(&quot;:silly.bzl&quot;, &quot;silly_binary&quot;)

silly_binary(
    name = &quot;hello&quot;,
    srcs = [&quot;hello.sil&quot;, &quot;world.sil&quot;],
)

## silly.bzl ############

_SillyCompilation = provider(fields = [&quot;compiled&quot;])

def _silly_compilation_impl(ctx):
    out = ctx.actions.declare_output(&quot;output.o&quot;)
    ctx.actions.run(cmd_args(
        ctx.attrs.toolchain.compiler,
        ctx.attrs.src,
        &quot;-o&quot;,
        out.as_output(),
    ))
    return [DefaultInfo(), _SillyCompilation(compiled = out)]

_silly_compilation = rule(
    impl = _silly_compilation_impl,
    attrs = {
        &quot;src&quot;: attrs.src(),
        &quot;toolchain&quot;: attrs.dep(),
    },
)

def _silly_binary_impl(ctx):
    def k(providers):
        # Step 2: now link them all together
        out = ctx.actions.declare_output(&quot;out.exe&quot;)
        objs = [p[_SillyCompilation].compiled for p in providers]
        ctx.actions.run(cmd_args(
            ctx.attrs._silly_toolchain.linker,
            objs,
            &quot;-o&quot;,
            out.as_output(),
        ))
        return [
            DefaultInfo(default_output = out),
            RunInfo(args = out),
        ]

    # Step 1: compile all my individual files
    return ctx.actions.anon_targets(
        [(_silly_compilation, {
            &quot;src&quot;: src,
            &quot;toolchain&quot;: ctx.attrs._silly_toolchain
        }) for src in ctx.attrs.srcs]
    ).map(k)

silly_binary = rule(
    impl = _silly_binary_impl,
    attrs = {
        &quot;srcs&quot;: attr.list(attr.src()),
        &quot;_silly_toolchain&quot;: attr.dep(default = &quot;toolchains//:silly&quot;),
    },
)
</code></pre>
<h2 id="convert-promise-to-artifact">Convert promise to artifact</h2>
<p>It can be challenging to pass around the promises from anon_target and structure
functions to support that. If you only need an artifact (or multiple artifacts)
from an anon_target, you can use <code>artifact()</code> function on the anon target to
convert a promise to an artifact. This artifact can be passed to most things
that expect artifacts, but until it is resolved (at the end of the current
analysis) it can&#x27;t be inspected with artifact functions like <code>.extension</code>, etc.
<code>.short_path</code> is supported if <code>ctx.actions.assert_short_path()</code> was called,
which produces an artifact type. The promise must resolve to a build (not
source) artifact with no associated artifacts.</p>
<p>Example:</p>
<pre><code class="language-python">HelloInfo = provider(fields = [&quot;hello&quot;, &quot;world&quot;])

def _anon_impl(ctx: AnalysisContext) -&gt; [&quot;provider&quot;]:
    hello = ctx.actions.write(&quot;hello.out&quot;, &quot;hello&quot;)
    world = ctx.actions.write(&quot;world.out&quot;, &quot;world&quot;)
    return [DefaultInfo(), HelloInfo(hello = hello, world = world)]

_anon = anon_rule(
    impl = _anon_impl,
    attrs = {},
    artifact_promise_mappings = {
        &quot;hello&quot;: lambda x: x[HelloInfo].hello,
        &quot;world&quot;: lambda x: x[HelloInfo].world,
    }
)

def _use_impl(ctx: AnalysisContext) -&gt; [&quot;provider&quot;]:
    anon = ctx.actions.anon_target(_anon, {})
    hello_artifact = anon.artifact(&quot;hello&quot;)
    world_artifact = anon.artifact(&quot;world&quot;)

    out = ctx.actions.declare_output(&quot;output&quot;)
    ctx.actions.run([
            ctx.attrs.some_tool,
            hello_artifact,
            world_artifact,
            out.as_output()
        ], category = &quot;process&quot;)
    return [DefaultInfo(default_output = out)]

use_promise_artifact = rule(impl = _use_impl, attrs = {
    &quot;some_tool&quot;: attr.exec_dep(),
})
</code></pre></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/rule_authors/dynamic_dependencies/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Dynamic Dependencies</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/rule_authors/test_execution/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Test Execution</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#anon-rule" class="table-of-contents__link toc-highlight">Anon rule</a></li><li><a href="#anon-target" class="table-of-contents__link toc-highlight">Anon target</a><ul><li><a href="#anontarget-and-anontargets" class="table-of-contents__link toc-highlight"><code>AnonTarget</code> and <code>AnonTargets</code></a></li></ul></li><li><a href="#attribute-resolution" class="table-of-contents__link toc-highlight">Attribute resolution</a><ul><li><a href="#name-attribute-example" class="table-of-contents__link toc-highlight"><code>name</code> attribute example</a></li></ul></li><li><a href="#simple-example" class="table-of-contents__link toc-highlight">Simple Example</a></li><li><a href="#longer-example" class="table-of-contents__link toc-highlight">Longer example</a></li><li><a href="#convert-promise-to-artifact" class="table-of-contents__link toc-highlight">Convert promise to artifact</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/">User guide</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/terms" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2024 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>