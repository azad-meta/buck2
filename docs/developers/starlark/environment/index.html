<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-developers/starlark/environment" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.1">
<title data-rh="true">Environments | Buck2</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://buck2.build/docs/developers/starlark/environment/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Environments | Buck2"><meta data-rh="true" name="description" content="explanation of the problem, and thought process behind it, remains useful. The"><meta data-rh="true" property="og:description" content="explanation of the problem, and thought process behind it, remains useful. The"><link data-rh="true" rel="icon" href="/img/logo.png"><link data-rh="true" rel="canonical" href="https://buck2.build/docs/developers/starlark/environment/"><link data-rh="true" rel="alternate" href="https://buck2.build/docs/developers/starlark/environment/" hreflang="en"><link data-rh="true" rel="alternate" href="https://buck2.build/docs/developers/starlark/environment/" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GEGGHE39PE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-GEGGHE39PE",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.c6c35c65.css">
<script src="/assets/js/runtime~main.81f3685b.js" defer="defer"></script>
<script src="/assets/js/main.7a8cf8da.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Buck2 Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Buck2 Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Buck2</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/docs/api/">API</a><a class="navbar__item navbar__link" href="/docs/prelude/globals/">Rules</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/about/why/">About Buck2</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/concepts/key_concepts/">Concepts</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/users/commands/aquery/">Buck2 Users</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/rule_authors/writing_rules/">Rule Authors</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/developers/bxl/">BXL Developers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/developers/architecture/buck2/">Buck2 Developers</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/developers/architecture/buck2/">Architecture</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developers/what-ran/">Finding Commands That Buck2 Ran</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/developers/starlark/environment/">Starlark Language</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developers/starlark/environment/">Environments</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developers/starlark/gc/">A Moving Garbage Collector</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developers/starlark/heaps/">Heaps and Heap References</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developers/starlark/spec/">Starlark Language Specification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developers/starlark/types/">Starlark Types</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developers/starlark/values/">Value Representation</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developers/request_for_comments/">Request for Comments</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developers/windows_cheat_sheet/">Windows Cheat Sheet</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Buck2 Developers</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Starlark Language</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Environments</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1 id="environments">Environments</h1></header>
<admonition title="Some of the information within this page is outdated. However, the" type="warning"><p>explanation of the problem, and thought process behind it, remains useful. The
storage of values is similar but implemented using different types. :::</p><p>Starlark (with a nested <code>def</code>) has a series of environments that may be active
during an evaluation, as illustrated in the following example:</p><pre><code class="language-python">x = []
def foo():
    y = True
    def bar():
        z = 1
        list.append(x, 1)
</code></pre><p>The above example features the following environments:</p><ul>
<li>Global environment - defining things like <code>list.append</code></li>
<li>Module environment - defining <code>x</code></li>
<li>Environment of <code>foo</code> - defining <code>y</code></li>
<li>Environment of <code>bar</code> - defining <code>z</code></li>
</ul><p>A scope can <em>access</em> variables defined above it, and often <em>mutate</em> them, but
not <em>assign</em> them.</p><p>To unpack that:</p><ul>
<li>From the statements inside <code>bar</code>, you can access <code>list.append</code>, <code>x</code>, <code>y</code>, and
<code>z</code>.</li>
<li>From inside <code>bar</code>, you can mutate the variables to be accessed with statements
like <code>list.append(x, 1)</code> (which may also be termed <code>x.append(1)</code>).<!-- -->
<ul>
<li>However, before this module is imported by another module, all of its
exports become <em>frozen</em>, which means it isn&#x27;t possible to mutate a global
list, and if <code>foo</code> is called from a different module, then <code>x</code> can&#x27;t be
modified.</li>
</ul>
</li>
<li>If <code>bar</code> does <code>x = 1</code> that defines a local variable <code>x</code> in the function <code>bar</code>,
shadowing the global <code>x</code>. As a consequence, you cannot assign to variables
defined in an outer scope.</li>
</ul><p>Note that assignment <em>after</em>, or even <em>in</em> non-executed conditional branches,
introduces a local variable.</p><p>For example:</p><pre><code class="language-python">x = 1
def f():
    print(x)
    if False:
        x = 2
</code></pre><p>In the above code, on executing <code>f()</code>, it would complain that <code>x</code> is referenced
before assignment, as the assignment <code>x = 2</code> makes <code>x</code> a local variable.</p><p>The rest of this document outlines the various types of environments, how they
are accessed, and how they are updated.</p><h2 id="global-environment">Global Environment</h2><p>The global environment is always frozen and consists of <em>functions</em> and
<em>type-values</em>. All things in the global environment are accessed by name.</p><p>Type-values are things like <code>list.append</code>, which is used when you do either
<code>list.append(xs, 1)</code> or <code>xs.append(1)</code>, assuming <code>xs</code> is of type <code>list</code>. The
available methods for a type can be queried (for example, <code>dir(list)</code>).</p><p>There are also global functions, such as <code>len</code>, <code>range</code>, and <code>str</code>.</p><h2 id="slots">Slots</h2><p>To optimise evaluation, all variables are accessed by integers, which are known
as &#x27;slots&#x27;. Many variables can be converted to slots statically during
compilation, and those which can&#x27;t have their slot looked up by name at runtime.</p><p>The <code>Slots</code> data type is defined as:</p><pre><code class="language-rust">enum Slots {
    Frozen(FrozenSlots),
    Slots(Rc&lt;RefCell&lt;Vec&lt;Option&lt;Value&gt;&gt;&gt;&gt;),
}

struct FrozenSlots(Arc&lt;Vec&lt;Option&lt;FrozenValue&gt;&gt;&gt;);
</code></pre><p>As featured in the above code:</p><ul>
<li>A set of slots are either <code>Frozen</code>, which came from another module behind
<code>Arc</code> or just normal <code>Slots</code>, which can be manipulated by the current scope
(behind a <code>Rc</code>/<code>RefCell</code> for single-threaded use and mutation).</li>
<li><code>Vec</code> is accessed by the slot index.</li>
<li><code>Option</code> refers to whether the slot has been assigned yet (to detect variables
referenced before assignment).</li>
</ul><h2 id="module-environment">Module Environment</h2><p>The module environment is where the module executes, namely where <code>x</code> is defined
above. The module environment can have values added in the following
standards-conforming ways:</p><ul>
<li>Assignment statements (such as <code>x = 1</code> or <code>x += 1</code>).</li>
<li><code>For</code> loops (such as the <code>x</code> in <code>for x in []:</code>).</li>
<li>Via the <code>load(&quot;a.bzl&quot;, &quot;foo&quot;)</code>, which imports <code>foo</code> frozen.</li>
<li>Via <code>def foo():</code>, which defines <code>foo</code> in the module environment. Whether a
<code>def</code> is frozen or not, when it&#x27;s executed, its local variables are not
frozen.</li>
</ul><p>In addition, two non-standards-conforming ways of defining variables are
supported:</p><ul>
<li>Some modules can be injected as bindings in advance. Given a module <code>foo</code> that
is injected, all the bindings of <code>foo</code> will be inserted in this module as
frozen.</li>
<li>The function <code>load_symbols</code> injects a dictionary of bindings into the module
environment.</li>
</ul><p>Note that a module has a fixed set of variables (from the standards-conforming
ways), a pre-execution set (from the injections) and yet more variables at
runtime (via <code>load_symbols</code>). To support that structure, the mapping from name
to slot index is tracked in a struct:</p><pre><code class="language-rust">enum Names {
    Frozen(FrozenNames),
    Names(Rc&lt;RefCell&lt;HashMap&lt;String, usize&gt;&gt;&gt;),
}
struct FrozenNames(Arc&lt;HashMap&lt;String, usize&gt;&gt;);
</code></pre><p>Each name is given an entry in the map with an increasing slot index. A name
will only be assigned a slot once, reusing it thereafter. A corresponding
<code>Slots</code> data type provides the values associated with those names.</p><p>Importantly, the <code>Slots</code> can be extended at runtime by the <code>load_symbols</code>
function. As with <code>Slots</code>, you can either share things behind an <code>Arc</code> or mutate
them behind an <code>Rc</code>/<code>RefCell</code>.</p><h2 id="function-environment">Function Environment</h2><p>A function can have variables introduced via assignments, <code>for</code> loops, and
parameters. No additional variables can be discovered at runtime, so all names
can be erased at compile time.</p><p>A function can also access variables from the functions it is statically nested
within, and from the variables at the root of the module. To support this
structure, at runtime we pass around the context, defined as:</p><pre><code class="language-rust">struct Context {
    names: Names,
    slots: Vec&lt;Slots&gt;,
}
</code></pre><p>The above code contains the mapping of names for the module and the slots for
the module and each function.</p><p>When executed, the inner-most <code>Slots</code> (at the end of <code>slots:</code>) will never be
frozen, as that represents the local variables: but any other may be.</p><p>When a function value is captured in a frozen module, use <code>FrozenContext</code>:</p><pre><code class="language-rust">struct FrozenContext {
    names: FrozenNames,
    slots: Vec&lt;FrozenSlots&gt;,
}

## List comprehension environments

A list comprehension can be defined as:

```python
[x for x in [1,2,3]]
</code></pre><p>In the above code:</p><ul>
<li>The statement defines a variable <code>x</code> that is immediately initialised and
shadows any other variables <code>x</code> in scope.</li>
<li>The variable <code>x</code> cannot be assigned to, other than in the list comprehension,
as it only lives inside the comprehension and the comprehension does not
permit assignment statements (only expressions). Such names are not available
at the top-level, even when defined in the root of a module.</li>
</ul><p>List comprehensions are implemented by adding additional entries into the
<code>Slots</code> data type. Even when added at the root of a module, such names are not
added to <code>Names</code>.</p><h2 id="optimisations">Optimisations</h2><p>There are a number of optimisations made to the scheme:</p><ul>
<li>When freezing a <code>Names</code> or <code>Slots</code> structure, it&#x27;s important to only freeze a
particular mutable variant once, or you duplicate memory unnecessarily.
Therefore, the <code>Slots</code> to be <code>Rc&lt;RefCell&lt;(_, Option&lt;FrozenSlots&gt;)&gt;&gt;</code> are
augmented, and, similarly, the <code>Names</code>.<!-- -->
<ul>
<li>When <code>freeze</code> is called, the original value is consumed, and the <code>Some</code>
variant is added.</li>
<li><strong>Note</strong>: it is unsafe to ever access the slots after the <code>freeze</code>.</li>
</ul>
</li>
<li>Programs can only assign to the inner-most <code>Slots</code>, and that slots must always
be mutable. Therefore, define a local <code>Slots</code> that is always mutable, and a
separate AST node for referring to it.<!-- -->
<ul>
<li>For modules, it is important that this mutable local <code>Slots</code> is <em>also</em> in
scope since the scope is used to retrieve unknown variables.</li>
</ul>
</li>
</ul></admonition></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developers/what-ran/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Finding Commands That Buck2 Ran</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/developers/starlark/gc/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">A Moving Garbage Collector</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#global-environment" class="table-of-contents__link toc-highlight">Global Environment</a></li><li><a href="#slots" class="table-of-contents__link toc-highlight">Slots</a></li><li><a href="#module-environment" class="table-of-contents__link toc-highlight">Module Environment</a></li><li><a href="#function-environment" class="table-of-contents__link toc-highlight">Function Environment</a></li><li><a href="#optimisations" class="table-of-contents__link toc-highlight">Optimisations</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/">User guide</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/facebook/buck2" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/terms" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.fb.com/legal/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>